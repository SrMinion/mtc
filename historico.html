<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“‹ HistÃ³rico de AvaliaÃ§Ãµes</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .registro {
      border: 2px solid #e9d5ff;
      padding: 20px;
      margin-bottom: 20px;
      background: linear-gradient(145deg, #faf5ff 0%, #f3e8ff 100%);
      border-radius: 15px;
      transition: all 0.3s ease;
      position: relative;
    }
    .registro:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
      border-color: #c4b5fd;
    }
    .registro strong {
      color: #6b46c1;
    }
    .registro-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    #lista {
        margin-top: 20px;
    }
    .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        position: absolute;
        top: 15px;
        right: 15px;
        opacity: 0.7;
    }
    .delete-btn:hover {
        background: #dc2626;
        opacity: 1;
    }
    .details-button {
        background: #64748b;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        margin-top: 10px;
        display: inline-block;
    }
    .details-button:hover {
        background: #475569;
    }
    .detailed-content {
        margin-top: 15px;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9d5ff;
    }
    .hidden {
        display: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://celiamtc.euonline.com.br/wp-content/uploads/2025/01/cropped-celialogo.png" alt="Logo" class="logo">
    <h1>ğŸ“‹ HistÃ³rico de AvaliaÃ§Ãµes MTC</h1>
    <nav class="main-nav">
        <a href="index.html">Nova AvaliaÃ§Ã£o</a>
        <a href="historico.html">HistÃ³rico</a>
    </nav>
  </header>

  <main>
    <section>
        <h2>ğŸ” Buscar no HistÃ³rico</h2>
        <input type="text" id="buscar" placeholder="Digite o nome do paciente para buscar..." />
    </section>

    <section id="lista-container">
        <h2>ğŸ“œ Registros Salvos</h2>
        <div id="lista">
            <p>Nenhuma avaliaÃ§Ã£o encontrada. Crie uma na pÃ¡gina de avaliaÃ§Ã£o.</p>
        </div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const buscarInput = document.getElementById('buscar');
        const listaDiv = document.getElementById('lista');
        let __avaliacoes__ = [];

        // Adicionando orgaoInfo para reconstruir relatÃ³rios
        const orgaoInfo = {
            'FÃ­gado': 'Armazena o sangue, regula o fluxo do Qi e emoÃ§Ãµes como raiva e frustraÃ§Ã£o. Relacionado Ã  visÃ£o e tendÃµes.',
            'BaÃ§o': 'Transforma e transporta nutrientes e lÃ­quidos. Relacionado Ã  digestÃ£o, mÃºsculos, concentraÃ§Ã£o e preocupaÃ§Ã£o.',
            'Rim': 'Armazena a essÃªncia (Jing), controla crescimento, reproduÃ§Ã£o, ossos, audiÃ§Ã£o e forÃ§a de vontade. EmoÃ§Ã£o: medo.',
            'CoraÃ§Ã£o': 'Governa o sangue e abriga o Shen (mente). Relacionado Ã  alegria, consciÃªncia e circulaÃ§Ã£o.',
            'PulmÃ£o': 'Controla a respiraÃ§Ã£o e o Qi. Rege a pele, a voz e as emoÃ§Ãµes como tristeza e melancolia.',
            'EstÃ´mago': 'ResponsÃ¡vel pela digestÃ£o e assimilaÃ§Ã£o de alimentos. Trabalha com o BaÃ§o.',
            'VesÃ­cula Biliar': 'Armazena bile e auxilia na digestÃ£o. Relacionada Ã  coragem e tomada de decisÃµes.',
            'Intestino Grosso': 'Elimina resÃ­duos. Relacionado Ã  clareza mental e capacidade de deixar ir.',
            'Bexiga': 'Armazena e elimina urina. Relacionada Ã  forÃ§a de vontade e determinaÃ§Ã£o.',
            'Ãštero': 'Conectado ao Rim e ao FÃ­gado. ResponsÃ¡vel pela reproduÃ§Ã£o e ciclo menstrual.',
            'Shen': 'Representa a mente, espÃ­rito e consciÃªncia. Abrigado no CoraÃ§Ã£o, essencial para equilÃ­brio emocional.',
            'Qi': 'Energia vital que circula pelo corpo. Fundamental para todas as funÃ§Ãµes orgÃ¢nicas.',
            'Yin': 'Aspecto nutritivo, refrescante e calmante da energia. Relacionado aos lÃ­quidos corporais.',
            'Sangue': 'Nutre e umedece os tecidos. Relacionado Ã  circulaÃ§Ã£o e nutriÃ§Ã£o celular.'
        };

        function carregarAvaliacoes(filtroNome = '') {
            try {
                const avaliacoesSalvas = JSON.parse(localStorage.getItem('avaliacoesMTC')) || [];
                __avaliacoes__ = avaliacoesSalvas;
                const avaliacoesFiltradas = __avaliacoes__.filter(item => 
                    item.nome.toLowerCase().includes(filtroNome.toLowerCase())
                );

                if (avaliacoesFiltradas.length === 0) {
                    listaDiv.innerHTML = '<p>Nenhum registro encontrado para a sua busca.</p>';
                    return;
                }

                listaDiv.innerHTML = avaliacoesFiltradas.sort((a, b) => b.id - a.id).map(item => `
                    <div class="registro" data-id="${item.id}">
                        <div class="registro-header">
                            <h3>${item.nome}</h3>
                            <button class="delete-btn" title="Excluir este registro">âœ–</button>
                        </div>
                        <p><strong>ğŸ“… Data:</strong> ${item.dataAvaliacao}</p>
                        <p><strong>ğŸ“Š Idade:</strong> ${item.idade}</p>
                        <p><strong>ğŸ§  Pontos por Sistema:</strong> ${formatarPontuacao(item.pontuacaoOrgaos)}</p>
                        <p><strong>ğŸ§° TÃ©cnicas:</strong> ${(item.tecnicasSelecionadas || []).join(', ') || 'Nenhuma'}</p>
                        <button class="details-button">Ver Detalhes</button>
                        <div class="detailed-content hidden"></div>
                    </div>
                `).join('');
            } catch (error) {
                console.error("Erro ao carregar avaliaÃ§Ãµes:", error);
                listaDiv.innerHTML = '<p>Ocorreu um erro ao carregar o histÃ³rico.</p>';
            }
        }

        function formatarPontuacao(pontuacao) {
            if (!pontuacao || Object.keys(pontuacao).length === 0) {
                return 'Nenhuma desarmonia pontuada.';
            }
            return Object.entries(pontuacao)
                .sort(([, a], [, b]) => b - a)
                .map(([orgao, pontos]) => `${orgao}: ${pontos}`)
                .join('; ');
        }
        
        function deletarAvaliacao(id) {
            if (!confirm('Tem certeza que deseja excluir este registro? Esta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
                return;
            }
            try {
                let avaliacoes = JSON.parse(localStorage.getItem('avaliacoesMTC')) || [];
                avaliacoes = avaliacoes.filter(item => item.id != id);
                localStorage.setItem('avaliacoesMTC', JSON.stringify(avaliacoes));
                carregarAvaliacoes(buscarInput.value); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao deletar avaliaÃ§Ã£o:", error);
                alert('Ocorreu um erro ao tentar deletar o registro.');
            }
        }
        
        function showDetails(button) {
            const registroDiv = button.closest('.registro');
            const detailDiv = registroDiv.querySelector('.detailed-content');
            const id = registroDiv.dataset.id;
            const avaliacao = __avaliacoes__.find(av => av.id == id);

            if (!avaliacao) return;

            if (button.textContent === "Ver Detalhes") {
                let content = '';
                content += '<h3>ğŸ§­ AvaliaÃ§Ã£o EnergÃ©tica Gerada</h3>';
                content += generatePatientInfoHTML(avaliacao);
                content += generateAnomaliesHTML(avaliacao.sintomas);
                content += generateDiagnosisHTML(avaliacao.sintomasDetalhados, avaliacao.pontuacaoOrgaos, orgaoInfo);
                content += generateOrganScoreHTML(avaliacao.pontuacaoOrgaos, orgaoInfo);
                // O plano terapÃªutico Ã© mais complexo e pode ser adicionado aqui se necessÃ¡rio.
                
                detailDiv.innerHTML = content;
                detailDiv.classList.remove('hidden');
                button.textContent = "Ocultar Detalhes";
            } else {
                detailDiv.classList.add('hidden');
                detailDiv.innerHTML = '';
                button.textContent = "Ver Detalhes";
            }
        }
        
        // FunÃ§Ãµes de GeraÃ§Ã£o de HTML (copiadas/adaptadas do script.js)
        function generatePatientInfoHTML(data) {
             return `
                <div id="dados-paciente-resultado">
                    <h3>ğŸ“‹ Dados do Paciente</h3>
                    <p><strong>ğŸ‘¤ Nome:</strong> ${data.nome}</p>
                    <p><strong>ğŸ‚ Data de Nascimento:</strong> ${new Date(data.dataNascimento).toLocaleDateString('pt-BR')}</p>
                    <p><strong>ğŸ“Š Idade:</strong> ${data.idade}</p>
                    <p><strong>ğŸ’¼ ProfissÃ£o:</strong> ${data.profissao || 'NÃ£o informado'}</p>
                    <p><strong>âš§ Sexo:</strong> ${data.sexo === 'mulher' ? 'ğŸ‘© Mulher' : 'ğŸ‘¨ Homem'}</p>
                    <p><strong>ğŸ“… Data da AvaliaÃ§Ã£o:</strong> ${data.dataAvaliacao}</p>
                </div>
            `;
        }
        function generateAnomaliesHTML(sintomas) {
            if (!sintomas || sintomas.length === 0) return '<p>Nenhuma anomalia/sintoma encontrado.</p>';
            return `
                <div id="anomalias-sintomas">
                    <h3>ğŸ“‹ Anomalias/Sintomas Encontrados</h3>
                    <ul>${sintomas.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
            `;
        }
        function generateDiagnosisHTML(sintomasDetalhados, pontuacao, info) {
            if (!sintomasDetalhados || sintomasDetalhados.length === 0) return '';
            const orgaoMaisAfetado = Object.keys(pontuacao).length > 0 ? Object.keys(pontuacao).reduce((a, b) => pontuacao[a] > pontuacao[b] ? a : b) : null;
            if (!orgaoMaisAfetado) return '';
            
            let interpretacao = `
                <div id="diagnostico-interpretacao" class="diagnostico-texto">
                    <h3>ğŸ” InterpretaÃ§Ã£o DiagnÃ³stica</h3>
                    <p><strong>ğŸ¯ Ã“rgÃ£o mais afetado:</strong> ${orgaoMaisAfetado} (${pontuacao[orgaoMaisAfetado]} pontos)</p>
                    ${info[orgaoMaisAfetado] ? `<p><strong>${orgaoMaisAfetado}:</strong> ${info[orgaoMaisAfetado]}</p>` : ''}
                    <h4>ğŸ”¬ PadrÃµes Identificados:</h4>
                    <ul>${sintomasDetalhados.slice(0, 5).map(item => `<li><strong>${item.sintoma.split(' ')[0]}:</strong> ${item.diagnostico}</li>`).join('')}</ul>
                </div>`;
            return interpretacao;
        }
        function generateOrganScoreHTML(pontuacao, info) {
            if (!pontuacao || Object.keys(pontuacao).length === 0) return '';
            const orgaosOrdenados = Object.entries(pontuacao).sort(([,a], [,b]) => b - a).slice(0, 5);

            let html = '<div id="pontuacao-orgao"><h3>ğŸ©º PontuaÃ§Ã£o por Ã“rgÃ£o/Sistema</h3>';
            orgaosOrdenados.forEach(([orgao, pontos]) => {
                html += `<div class="orgao-info"><p><strong>${orgao}:</strong> ${pontos} ponto(s)</p></div>`;
            });
            html += '</div>';
            return html;
        }

        buscarInput.addEventListener('input', (e) => {
            carregarAvaliacoes(e.target.value);
        });
        
        listaDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const registroDiv = e.target.closest('.registro');
                if(registroDiv) {
                    deletarAvaliacao(registroDiv.dataset.id);
                }
            }
            if (e.target.classList.contains('details-button')) {
                showDetails(e.target);
            }
        });

        carregarAvaliacoes();
    });
  </script>
</body>
</html>